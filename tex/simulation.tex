\chapter{Event simulation}
\label{sec:simulation}

An accurate simulation of the physics processes and of the interaction
of particles with the detector is necessary to model the impact of the
analysis procedure on the measured quantities, and to estimate the
background composition expected in data. A set of computer programs
known as Monte Carlo (MC) event generators simulates the physical
processes.
Pseudo-random numbers are used to simulate the event-by-event
fluctuations intrinsic of quantum processes. MC generators make use of
the factorization principle (see
Section~\ref{sec:factprinciple}--reference to theory chapter); therefore, the
different phases of the $pp$ collision are considered independently.

\section{Simulation of pp collisions}
\label{sec:MCsimulation}

A pp collision event in Monte Carlo simulation
is the combination of different sub-processes,
illustrated in Figure~\ref{fig:collision}.
The event is simulated in several steps. Two protons collide and
undergo a deep inelastic interaction with a large momentum transfer.
The process of interest is generated by the {\it hard interaction} of
two partons within the protons and it is computed at a fixed order (LO
or NLO) in perturbation theory. 
The lower energy interactions between the proton remnants,
referred to as {\it underlying event} (UE), are described with
phenomenological models.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.9\textwidth]{figures/simulation/ppcollision}
    \caption[General structure of a hard $pp$ collision]{
      The general structure of a hard $pp$ collision: the hard process
      (HP) is described as an interaction among fundamental, freely
      moving constituents; the radiation process continues until the
      hadronization scale (H) is reached. The underlying event (UE) is
    described by the soft, multiple interactions among partons not
    involved in the hard process~\cite{mangano2005}.}
    \label{fig:collision}
  \end{center}
\end{figure}

Since the partons involved in the hard interaction are color charged,
they can radiate gluons. Emission associated with the two colliding partons  
is referred to as {\it Initial State Radiation} (ISR), while {\it
  Final State Radiation} (FSR) is emitted by the partons produced in
the collision. The emitted gluons can emit further gluons or split in
quark/anti-quark pairs, leading to the formation of {\it parton
  showers}.

The radiation process is effectively described by perturbative QCD until
the showers develop into processes at energy below
$\approx{}1~\GeV{}$. 
At this stage, {\it hadronization} takes place, where partons are
bound into colorless hadrons. Phenomenological models are used to
describe the decay of hadrons into the final state particles that
interact with the detector.

\subsection{Hard interaction}
\label{sec:hardinteraction}

The event simulation begins with the collision, with large transfer of
momentum, of two partons within the protons. At high energy scale, the
partons behave as asymptotically free, and a perturbative description
is applied. The QCD cross section for a generic process $pp\to X$ is
defined (Section~\ref{theorychapter}-reference to theory chapter) as

\begin{equation}
  \sigma_{{\rm pp}\to{\rm X}}
  = \sum_{a,b}
  \int{\rm d}x_a{\rm d}x_b
  ~ \int
  ~ f_a(x_a) f_b(x_b)
  {\rm d}\hat{\sigma}_{\rm ab}(x_ap_a, x_bp_b) \\
  \label{eq:qcdxsec}
\end{equation}

where $x_{a(b)}$ is the fraction of momentum carried by the colliding
parton within the proton $p_{a(b)}$, with PDF $f_{a(b)}$.

The fractions of momentum and flavors of the colliding partons are
selected by sampling the PDFs of the proton at the energy scale of the
process. The cross section for the partonic process $\hat{\sigma}_{\rm
  ab}(x_ap_a, x_bp_b)$ is computed explicitly at the lowest relevant
order in perturbation theory.

\subsection{Parton shower}
\label{sec:partonshower}

The parton showers represent higher-order corrections to the hard
interaction, corresponding to the production of additional partons.
Since radiative corrections at a fixed perturbative order are
divergent at low energies ({\it infrared divergence}) or small angles
({\it collinear divergence}), the explicit calculation is not possible,
and an approximation scheme is used where only the dominant
contributions are considered.

There are three possible processes for QCD emission ({\it splitting}): 
$q\to gq$, $g\to gg$ and $g\to q\bar{q}$.
The cross section for each of these processes corresponds to the
product of the production cross section for the original parton and a
factor accounting for the splitting probability. Hence, for each
splitting process $i$, the ($n+1$)-parton differential cross section is
defined, at the LO, by

\begin{equation}
  d\sigma_{n+1}\approx{} d\sigma_{n}
  \frac{\alpha_S}{2\pi}\frac{d\theta^2}{\theta^2} dz~d\phi~P_i(z,\phi) 
 \label{eq:splitting}
\end{equation}

where $\theta$ and $\phi$ are the opening angle and azimuthal angle of
the splitting, and $P_i$ is the splitting function, which describes
the distribution of the fraction $z$ of energy of the original parton,
assigned to the new parton.
The simulation algorithm develops the shower by applying
Eq.~\ref{eq:splitting} iteratively, for each parton involved in the
hard interaction.

In order to define the starting and final stage of the evolution of
the parton shower, the {\it virtuality} $q^2$ of the parton undergoing
the splitting is defined as the invariant mass of the two partons
produced. The initial virtuality is required to be smaller than the
momentum transfer of the hard process, and the shower is terminated
when the virtuality has fallen below the hadronization scale
($q^2=Q_0^2\simeq1\GeV^2$).
The parton shower takes into account virtual emissions that are
reabsorbed in quantum loops as a probability of {\it not} splitting in
a given virtuality range $[q_1^2,q_2^2]$. Such probability is referred
to as {\it Sudakov form factor}

\begin{equation}
  \label{eq:sudakov} 
  \Delta_i (q_1^2, q_2^2) = \exp \left[ - \int_{q_2^2}^{q_1^2}
    \frac{dq^2}{q^2} \frac{\alpha_S}{2\pi}
    \int_{\frac{Q_0^2}{q^2}}^{1-\frac{Q_0^2}{q^2}} dz \int_0^{2\pi} d\phi{} P_{i} (z,\phi) \right]
  \end{equation}

The evolution of the parton shower is therefore governed by the
Sudakov factor. Given the initial scale $Q^2$, the MC generator solves
the equation $\Delta_i(Q^2, q_1^2)=R_1$, where $R_1$ is a random
number uniform on the interval [0,1], for the virtuality $q_1^2$ of
the first splitting. If the condition $q_1^2<Q_0^2$ is met, the shower
development is terminated and hadronization takes place. Otherwise,
the procedure is repeated for each new parton produced by the
splitting, taking $q_1^2$ as initial scale.
For each splitting the variables $z$ and $\phi$ are generated
according to the distribution defined by the splitting function.

\subsubsection{ISR and FSR showers}
\label{sec:isrfsr}

The description above applies to the development of showers
associated with partons produced in the hard interaction, starting at
a high energy scale $Q^2$ and progressively reaching the hadronization
scale. This process is typical of FSR parton showers that are
generated from outgoing partons of the hard interaction.

In the case of ISR parton showers, the radiation is emitted by the
colliding partons, and there is an important difference in the shower
evolution, as the final energy of the showering is set by the hard
interaction energy scale.
MC generators implement a mechanism of {\it backward evolution} that
first sets the correct parton momentum fractions for the hard scatter,
and then develops the showers backward, with the intermediate partons
gaining energy at each emission. The Sudakov form factors are then
slightly different from Equation~\ref{eq:sudakov}, being rescaled by a
factor that takes into account the PDFs of the parton before and after
splitting. This procedure ensures a highly efficient simulation, as
only ISR showers compatible with the energy scale of the hard
interaction are generated. 

\subsection{Hadronization}
\label{sec:hadronization}

When the shower evolution brings the parton virtuality $q^2$ below the
hadronization scale $Q_0^2\simeq1\GeV^2$, the dynamics of the parton
enters a non-perturbative phase, which leads to the formation of the
final-state colorless hadrons. The hadronization process cannot
therefore be described with perturbative QCD, and MC generators rely on
phenomenological models.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.9\textwidth]{figures/simulation/hadromodels}
    \caption[Hadronization models]{
      Possible radiation pattern from a $q\bar{q}$ pair (a), and
      illustration of string fragmentation (b) and cluster
      hadronization (c)~\cite{mangano2005}.}
    \label{fig:hadronization}
  \end{center}
\end{figure}


Two phenomenological hadronization models are typically used to bound
partons into hadrons.
In the {\it Lund string model}, the confinement between partons
induced by the color force is represented by a gluonic string. In the
case of a quark-antiquark pair, as the color charges move apart, the
string is stretched, and its potential energy grows. When the energy
becomes of the order of hadron masses, it becomes energetically
favorable for the string to break and create a new quark-antiquark
pair. The two segments of string will stretch and break again, until
all the energy has been converted into quark-antiquark pairs connected
by short strings. In the case of more complicated color structures,
multiple strings are considered with as many endpoints as the color
charges available.

The other hadronization scheme is the {\it cluster model}, where
final state gluons are forced to split into quark-antiquark pairs,
and partons are grouped to form colorless clusters.
At the hadronization scale, most clusters have masses below $3$ GeV, and
their decay into hadrons is simulated with three-body models with
intermediate resonances ({\it quasi-two-body decay}). 
Clusters with higher masses are decomposed using a string-like
mechanism.

\subsection{Underlying event}
\label{sec:underlyingevent}

In $pp$ collision events containing a hard interaction, an additional
hadron production mechanism arises from the softer interaction of
spectator partons. Because of the low energy scale of these processes,
phenomenological models, whose parameters are tuned based on
experimental data, are used. 
The dominant subprocess of the underlying event is gluon-gluon
scattering, with a cross section larger than the total $pp$ scattering
cross section, indicating that multiple gluon scatterings per proton
collision are likely. 
For this reason the generic soft scattering of partons is referred to
as {\it multiple parton interactions} (MPI) and is modeled in MC
generators as the production of back-to-back jet pairs with little
total transverse momentum. 
The color connection with the beam remnants that are not
interacting is also simulated with phenomenological models.

\section{Generators}\label{sec:generators}

Generators are classified as either {\it multi-purpose}
generators, capable of performing the full simulation chain described
above, or as {\it specialized} generators, optimized for
an accurate simulation of specific aspects.
The following sections summarize the characteristics of the MC
generators used in this work.

\subsubsection*{PYTHIA}

\texttt{PYTHIA}~\cite{pythia6,pythia8} is a multi-purpose MC
generator using LO calculations for $2 \to n$ ($n\leq 3$) processes
and PS with emissions ordered in transverse momentum. 
The Lund string model is used for hadronization, and UE simulation is
included.

\subsubsection*{HERWIG}

\texttt{HERWIG}~\cite{herwig} is a multi-purpose MC generator using LO
calculations for $2 \to 2$ processes and PS with emissions ordered in
opening angle. 
The cluster model is used for hadronization and for the UE
description, \texttt{HERWIG} is typically interfaced with the
standalone software \texttt{JIMMY}~\cite{jimmy} that simulates UE as MPI.

\subsubsection*{ACERMC}

\texttt{ACERMC}~\cite{acermc} is a MC generator computing LO cross
sections and typically interfaced either with \texttt{PYTHIA} or 
\texttt{HERWIG} for the modeling of PS, hadronization and UE.

\subsubsection*{ALPGEN}

\texttt{ALPGEN}~\cite{alpgen} is a MC generator specialized
for LO calculations of $2 \to n$ ($n\leq 9$)
processes. It is interfaced with either
\texttt{PYTHIA} or \texttt{HERWIG} for PS development and
hadronization. UE is simulated through \texttt{PYTHIA}. 

\subsubsection*{MC@NLO}

\texttt{MC@NLO}~\cite{mcatnlo} is a MC generator using NLO
calculations. The full NLO correction provides precise cross section
estimates, but higher-multiplicity parton emissions are simulated via
\texttt{HERWIG} PS with a poor description of hard emissions. 
Hadronization and UE are simulated through \texttt{HERWIG} and
\texttt{JIMMY}.

\subsubsection*{POWHEG}

\texttt{POWHEG}~\cite{powheg} is a MC generator computing NLO cross
sections and typically interfaced either with \texttt{PYTHIA} or
\texttt{HERWIG} for the modeling of PS, hadronization and UE. 

\section{ATLAS detector simulation}
\label{sec:detectorsim}

The MC generators create a list of four-vectors of all stable
particles produced in the $pp$ collision. The simulation of the
experimental setup~\cite{atlas_sim} then propagates all final state
particles through the ATLAS detector and converts the energy
depositions into electronic signals simulating the readout system.
The interaction of particles with the detector, taking into account
its materials, geometry and readout system, is modeled using the {\tt
  GEANT4}~\cite{geant} package.

The \texttt{GEANT4} parameters are tuned using test-beam data and the
accuracy of the detector simulation in $pp$ collision data. The
detector simulation is based on the information from the {\it geometry
  database}, which contains the description of the detector volumes in
terms of dimensions, geometry, position and material composition, while
the {\it conditions database} provides the information
on the detector real-time conditions like dead channels, misalignments,
temperatures. Since conditions vary from run to run, it is important that
the detector simulation reproduces as close as possible the real status
of ATLAS during a particular data period. To ensure this,
simulation samples are reprocessed for each {\it data releases}.

\section{Monte Carlo simulation weighting and corrections}
\label{sec:mcweights}

In order to compare with the distributions observed in data, the
simulated samples are normalized to the number of events expected
based on the theoretical cross section and the integrated luminosity.
An event weight $w$ is applied, defined as:
\begin{equation}\label{eq:mcweight}
w = \dfrac{\sigma\times k}{N} L,
\end{equation}
where $\sigma$ is the process theoretical cross section, $N$ is the
number of simulated events, $L$ the integrated luminosity and $k$ a
correction to the LO cross section to reproduce a higher-order
(e.g. NLO) calculation.

In addition, a weight to account for pile-up effect is applied so that
the number of interactions per bunch crossing $<\mu>$ matches real
data-taking conditions.

In order to ensure an accurate modeling of the detector effects,
data-driven corrections are applied to the simulated samples.
The reconstruction efficiency, energy scale and resolution of the
different physics objects are calibrated based on precise
measurements. 