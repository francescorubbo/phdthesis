\chapter{Event Simulation}
\label{sec:simulation}

An accurate simulation of the physics processes and of the interaction
of particles with the detector is necessary to model the impact of the
analysis procedure on the measured quantities, and to estimate the
background composition expected in data. A set of computer programs
known as Monte Carlo (MC) event generators simulates the physics
processes.
Pseudo-random numbers are used to simulate the event-by-event
fluctuations intrinsic of quantum processes. MC generators make use of
factorization theorems (see Sec.~\ref{sec:topprod}); therefore, the
different phases of the $pp$ collision are considered independently.
Finally MC techniques are also used to simulate the interaction of
particles with the detector materials and the subsequent data--taking.

\section{Simulation of $pp$ collisions}
\label{sec:MCsimulation}

A Monte Carlo simulation of a $pp$ collision event involves the
modeling of different sub-processes, illustrated in
Figure~\ref{fig:collision}.
The event is simulated in several steps. Two protons collide and
undergo a deep inelastic interaction with a large momentum transfer.
The process of interest is generated by the {\it hard interaction} of
two partons within the protons and it is computed at a fixed order (LO
or NLO) in perturbation theory. 
The lower energy interactions between the proton remnants,
referred to as {\it underlying event} (UE), are described with
phenomenological models.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.9\textwidth]{figures/simulation/ppcollision}
    \caption[General structure of a hard $pp$ collision]{
      The general structure of a hard $pp$ collision: the hard process
      (HP) is described as an interaction among fundamental, freely
      moving constituents; the radiation process continues until the
      hadronization scale (H) is reached. The underlying event (UE) is
    described by the soft, multiple interactions among partons not
    involved in the hard process~\cite{mangano2005}.}
    \label{fig:collision}
  \end{center}
\end{figure}

Since the partons involved in the hard interaction are color charged,
they can radiate gluons. Emission associated with the two colliding partons  
is referred to as {\it Initial State Radiation} (ISR), while {\it
  Final State Radiation} (FSR) is emitted by the partons produced in
the collision. The emitted gluons can emit further gluons or split in
quark/anti-quark pairs, leading to the formation of {\it parton
  showers}.

The radiation process is effectively described by perturbative QCD until
the showers develop into processes at energy below
$\approx{}1~\GeV{}$. 
At this stage, {\it hadronization} takes place, where partons are
bound into colorless hadrons. Phenomenological models are used to
describe the hadronization step as well as the decay of hadrons into
the final state particles that interact with the detector.

\subsection{Hard interaction}
\label{sec:hardinteraction}

The event simulation begins with the collision, with large transfer of
momentum, of two partons within the protons. At high energy scale, the
partons behave as asymptotically free, and a perturbative description
is applied. The QCD cross section for a generic process $pp\to X$ is
defined (see Sec.~\ref{sec:topprod}) in terms of the cross section for
the partonic processes $\hat{\sigma}$ as

\begin{equation}
  \sigma_{{\rm pp}\to{\rm X}}
  = \sum_{a,b}
  \int{\rm d}x_a{\rm d}x_b
  ~ \int
  ~ f_a(x_a,\renormscale{},\factscale{}) f_b(x_b,\renormscale{},\factscale{})
  {\rm d}\hat{\sigma}_{\rm ab}(x_ap_a, x_bp_b,\renormscale{},\factscale{}) \\
  \label{eq:qcdxsec}
\end{equation}

where $x_{a(b)}$ is the fraction of momentum carried by the colliding
parton within the proton $p_{a(b)}$, with PDF $f_{a(b)}$.

The fractions of momentum and flavors of the colliding partons are
selected by sampling the PDFs of the proton at the energy scale of the
process. The cross section for the partonic process $\hat{\sigma}_{\rm
  ab}(x_ap_a, x_bp_b)$ is computed explicitly at the lowest relevant
order in perturbation theory. This step is also referred to as {\it
  Matrix Element} (ME) calculation, because it involves the
calculation of the scattering matrix relating the initial and final
state particles of the process.

\subsection{Parton shower}
\label{sec:partonshower}

The {\it parton showers} (PS) represent higher-order corrections to the hard
interaction $2\to n$, corresponding to the production of additional
partons in the process $2\to n+X$.
Since radiative corrections at a fixed perturbative order are
divergent at low energies ({\it infrared divergence}) or small angles
({\it collinear divergence}), the explicit calculation is not possible,
and an approximation scheme is used where only the dominant
contributions are considered.
There are three possible processes for QCD emission ({\it splitting}): 
$q\to gq$, $g\to gg$ and $g\to q\bar{q}$.
The partonic cross section for the process with one emission ($2\to
n+1$) can be expressed as the product of the $2\to n$ cross section
and a factor accounting for the splitting probability of one of the
partons. 
Hence, for each splitting process $i$, the ($2\to n+1$) differential
cross section is defined by
\begin{equation}
  d\sigma_{2\to n+1}\approx{} d\sigma_{2\to n}
  \frac{\alpha_S}{2\pi}\frac{d\theta^2}{\theta^2} dz~d\phi~P_i(z,\phi) 
 \label{eq:splitting}
\end{equation}
where $\theta$ and $\phi$ are the opening angle and azimuthal angle of
the splitting, and $P_i$ is the splitting function, which describes
the distribution of the fraction $z$ of energy of the original parton,
assigned to the new parton.
The simulation algorithm develops the shower by applying
Eq.~\ref{eq:splitting} iteratively, for each parton involved in the
hard interaction.

In order to define the starting and final stage of the evolution of
the parton shower, the {\it virtuality} $q^2$ of the parton undergoing
the splitting is defined as the invariant mass of the two partons
produced. The initial virtuality is required to be smaller than the
momentum transfer of the hard process, and the shower is terminated
when the virtuality has fallen below the hadronization scale
($q^2=Q_0^2\simeq1\GeV^2$).
From Eq.~\ref{eq:splitting} the probability of {\it not} splitting in
a given virtuality range $[q_1^2,q_2^2]$ can be computed. Such
probability is referred to as {\it Sudakov form factor}
\begin{equation}
  \label{eq:sudakov} 
  \Delta_i (q_1^2, q_2^2) = \exp \left[ - \int_{q_2^2}^{q_1^2}
    \frac{dq^2}{q^2} \frac{\alpha_S}{2\pi}
    \int_{\frac{Q_0^2}{q^2}}^{1-\frac{Q_0^2}{q^2}} dz \int_0^{2\pi} d\phi{} P_{i} (z,\phi) \right]
  \end{equation}

The evolution of the parton shower is therefore governed by the
Sudakov factor. Given the initial scale $Q^2$, the MC generator solves
the equation $\Delta_i(Q^2, q_1^2)=R_1$, where $R_1$ is a random
number uniform on the interval [0,1], for the virtuality $q_1^2$ of
the first splitting. If the condition $q_1^2<Q_0^2$ is met, the shower
development is terminated and hadronization takes place. Otherwise,
the procedure is repeated for each new parton produced by the
splitting, taking $q_1^2$ as initial scale.
For each splitting the variables $z$ and $\phi$ are generated
according to the distribution defined by the splitting function.

\subsubsection{ISR and FSR showers}
\label{sec:isrfsr}

The description above applies to the development of showers
associated with partons produced in the hard interaction, starting at
a high energy scale $Q^2$ and progressively reaching the hadronization
scale. This process is typical of FSR parton showers that are
generated from outgoing partons of the hard interaction.

In the case of ISR parton showers, the radiation is emitted by the
colliding partons, and there is an important difference in the shower
evolution, as the final energy of the showering is set by the hard
interaction energy scale.
MC generators implement a mechanism of {\it backward evolution} that
first sets the correct parton momentum fractions for the hard scatter,
and then develops the showers backward, with the intermediate partons
gaining energy at each emission. The Sudakov form factors are then
slightly different from Equation~\ref{eq:sudakov}, being rescaled by a
factor that takes into account the PDFs of the parton before and after
splitting. This procedure ensures a highly efficient simulation, as
only ISR showers compatible with the energy scale of the hard
interaction are generated. 

\subsubsection{Matrix element and parton shower matching}
\label{sec:matching}
 
Matrix element calculations in multi--leg or NLO generators include
ISR and FSR emissions with a cut-off to prevent collinear
and soft divergences. Therefore the PS algorithm is used to simulate
only soft and collinear emissions.
The interface of PS algorithms with NLO ME generators requires a
criterium to define which portion of the phase space is simulated by
which algorithm. The procedure to distinguish between hard and
large--angle emissions, described by the ME, and soft and collinear
emissions, described by the PS, is referred to as {\it ME and PS
  matching}.

Two main matching schemes are used: the method developed by
Catani--Krauss--Kuhn--Webber (CKKW~\cite{Catani:2001cc}) and the one by
Michelangelo L. Mangano (MLM~\cite{Mangano:2006rw}).
Both methods rely on re--clustering the final state partons, using a
$k_T$ algorithm~\cite{Catani:1991hj}, in order to identify the
radiation patterns generated at ME level. The generation of PS
emissions in the same phase space is then prevented by vetoing hard
and large angle radiation (CKKW) or rejecting events where the
re--clustered partons after PS do not match the ME final state (MLM).

\subsection{Hadronization}
\label{sec:hadronization}

When the shower evolution brings the parton virtuality $q^2$ below the
hadronization scale $Q_0^2\simeq1\GeV^2$, the dynamics of the parton
enters a non-perturbative phase, which leads to the formation of the
final-state colorless hadrons. The hadronization process cannot
therefore be described with perturbative QCD, and MC generators rely on
phenomenological models whose parameters are tuned to measurements in
data.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.9\textwidth]{figures/simulation/hadromodels}
    \caption[Hadronization models]{
      Possible radiation pattern from a $q\bar{q}$ pair (a), and
      illustration of string fragmentation (b) and cluster
      hadronization (c)~\cite{mangano2005}.}
    \label{fig:hadronization}
  \end{center}
\end{figure}

Two phenomenological hadronization models are typically used to bound
partons into hadrons.
In the {\it Lund string model}, the confinement between partons
induced by the color force is represented by a gluonic string. In the
case of a quark-antiquark pair, as the color charges move apart, the
string is stretched, and its potential energy grows. When the energy
becomes of the order of hadron masses, it becomes energetically
favorable for the string to break and create a new quark-antiquark
pair. The two segments of string will stretch and break again, until
all the energy has been converted into quark-antiquark pairs connected
by short strings. In the case of more complicated color structures,
multiple strings are considered with as many endpoints as the color
charges available.
The other hadronization scheme is the {\it cluster model}, where
final state gluons are forced to split into quark-antiquark pairs,
and partons are grouped to form colorless clusters.
At the hadronization scale, most clusters have masses below $3$ GeV, and
their decay into hadrons is simulated with three-body models with
intermediate resonances ({\it quasi-two-body decay}). 
Clusters with higher masses are decomposed using a string-like
mechanism.

\subsection{Underlying event}
\label{sec:underlyingevent}

In $pp$ collision events containing a hard interaction, an additional
hadron production mechanism arises from the softer interaction of
spectator partons. Because of the low energy scale of these processes,
phenomenological models, whose parameters are tuned based on
experimental data, are used. 
The dominant subprocess of the underlying event is gluon-gluon
scattering, with a cross section larger than the total $pp$ scattering
cross section, indicating that multiple gluon scatterings per proton
collision are likely. 
For this reason the generic soft scattering of partons is referred to
as {\it multiple parton interactions} (MPI) and is modeled in MC
generators as the production of back-to-back jet pairs with little
total transverse momentum. 
The color connection with the beam remnants that are not
interacting is also simulated with phenomenological models.

\section{Generators}
\label{sec:generators}

Generators are classified as either {\it multi-purpose}
generators, capable of performing the full simulation chain described
above, or as {\it specialized} generators, optimized for
an accurate simulation of specific aspects.
The following sections summarize the characteristics of the MC
generators used in this work.

\subsubsection*{General-purpose generators}

\paragraph{PYTHIA}~\cite{pythia6,pythia8} is a multi-purpose MC
generator using LO calculations for $2 \to n$ ($n\leq 3$) processes
and PS with emissions ordered in transverse momentum. 
The Lund string model is used for hadronization, and UE simulation is
included.

\paragraph{HERWIG}~\cite{herwig} is a multi-purpose MC generator using LO
calculations for $2 \to 2$ processes and PS with emissions ordered in
opening angle. 
The cluster model is used for hadronization and for the UE
description, \texttt{HERWIG} is typically interfaced with the
standalone software \texttt{JIMMY}~\cite{jimmy} that simulates UE as MPI.

\subsubsection*{Specialized generators}

\paragraph{ACERMC}~\cite{acermc} is a MC generator using LO
calculations of massive ME for typical LHC background processes. It is
interfaced either with \texttt{PYTHIA} or \texttt{HERWIG} for the
modeling of PS, hadronization and UE.

\paragraph{ALPGEN}~\cite{alpgen} is a MC generator using LO calculations
of $2 \to n$ ($n\leq 9$) processes. It is interfaced with either
\texttt{PYTHIA} or \texttt{HERWIG} for PS development and
hadronization. UE is simulated through \texttt{PYTHIA}. Being a
multi--leg generator it can be used to simulate LO processes with
additional radiation at the ME level; therefore ME and PS matching is
applied with the MLM method.

\subsubsection*{NLO generators}

\paragraph{MC@NLO}~\cite{mcatnlo} is a MC generator using NLO
calculations. The full NLO ME provides precise cross section
estimates, but higher-multiplicity parton emissions are simulated via
\texttt{HERWIG} PS with a poor description of hard emissions. The ME
and PS matching is performed by a built--in CKKW--like subtraction
procedure.
Hadronization and UE are simulated through \texttt{HERWIG} and
\texttt{JIMMY}.

\paragraph{POWHEG}~\cite{powheg} is a MC generator using NLO
calculations and typically interfaced either with \texttt{PYTHIA} or
\texttt{HERWIG} for the modeling of PS, hadronization and UE.

\section{ATLAS detector simulation}
\label{sec:detectorsim}

The MC generators create a list of final state particles of the
process considered ({\it truth level}), and simulate the decays of the
unstable ones, which decay before hadronization takes place. 
The final output is a list of four-vectors of all stable
particles produced in the $pp$ collision ({\it particle level}). 
The detector simulation software reproduces the interaction of these
particles with the experimental setup~\cite{atlas_sim}, by propagating
all final state particles through the ATLAS detector and converting
the energy deposits into electronic signals simulating the readout
system. 
The interaction of particles with the detector, taking into account
its materials, geometry and readout system, is modeled using the {\tt
  GEANT4}~\cite{geant} package.

The \texttt{GEANT4} parameters are tuned using test-beam and $pp$
collision data. The accuracy of the detector simulation is based on
the information from the {\it geometry database}, which contains the
description of the detector volumes in terms of dimensions, geometry,
position and material composition, while the {\it conditions database}
provides the information on the detector real-time conditions like
dead channels, misalignments, or temperatures. Since conditions vary
from run to run, it is important that the detector simulation
reproduces as close as possible the real status of ATLAS during a
particular data period. To ensure this, simulation samples are
reprocessed for each {\it data release}. 
The release 17.0.3.3 of the \texttt{ATHENA}
framework~\cite{Calafiura:865624} is used for processing the dataset
and simulation at \seventev{}, while the samples at \eighttev{} are
processed with versions 17.2.7.4 and 17.2.6.5.

\section{Monte Carlo simulation weighting and corrections}
\label{sec:mcweights}

In order to compare with the distributions observed in data, the
simulated samples are normalized to the number of events expected
based on the theoretical cross section and the integrated luminosity.
An event weight $w$ is applied, defined as:
\begin{equation}\label{eq:mcweight}
w = \dfrac{\sigma\times k}{N} L,
\end{equation}
where $\sigma$ is the process theoretical cross section, $N$ is the
number of simulated events, $L$ the integrated luminosity and $k$ a
correction to the LO cross section to reproduce a higher--order
(e.g. NLO) calculation for the process of interest.

In addition, a weight is applied  to account for the pile--up
conditions in data. While events are generated for the whole spectrum
of number of interactions per bunch crossing $<\mu>$, the proportions
are not the same as in data. The pile--up weight ensures that the
$<\mu>$ distribution in simulated samples matches the one in data.
To ensure an accurate modeling of the detector effects, reconstruction
and selection efficiencies $\epsilon$ are calibrated with {\it scale factors}
(SF) defined as 
\begin{equation}
SF = \frac{\epsilon_{DATA}}{\epsilon_{MC}}
\end{equation}
where $\epsilon_{DATA}$ is measured in dedicated data control samples.
Analogously, energy scale and resolution of the different physics
objects in the simulation are corrected to match the corresponding
measurements in data.